/*
 * app.js - the Zanimo animation editor
 */

"use strict";

var app = {},
    VERSION = 25,
    Q = require('q'),
    qstart = require('qstart'),
    _$ = require('./$'),
    curtain = require('./curtain'),
    store = require('./store'),
    editor = require('./editor'),
    user = require('./user'),
    runner = require('./runner'),
    route = require('./route');

// fix layout when no CSS calc() support available
function fixCSSCalc() {
    var dummy = _$.DOM("div"), calc = null;

    ["", "-webkit-", "-moz-", "-ms-"].forEach(function (prefix) {
        var t = prefix + "calc(10px)";
        dummy.style.cssText = "width:" + t + ";";
        if(dummy.style.width === t) calc = prefix + "calc";
    });

    if (calc !== null) return;

    var $doc = _$.$(".documentation section.content"),
        $content = _$.$(".documentation section.content div.doc-content"),
        $editor = _$.$(".CodeMirror"),
        fixLayout = function () {
            var h = _$.getViewportHeight();
            $doc.style.height = (h - 30) + "px";
            $content.style.height = (h - 65) + "px";
            if($editor) $editor.style.height = (h - 80) + "px";
        };
    if(!_$.isTouchable) window.addEventListener("resize", fixLayout);
    window.addEventListener("orientationchange", fixLayout);
    fixLayout();
}

app.openCurtain = function () {
    Q.when(Q.delay(1000), function () {
        curtain.animate().then(curtain.bind)
    });
};

/*
 * app actions
 */

app.onActionOAuthRedirect = function (match) {
    user.onOAuthRedirect(match);
    app.openCurtain();
};

app.onActionRunner = function (match) {
    if(editor.add(match[2], window.atob(match[3])))
        runner.run(editor.getValue());
};

app.onActionDefault = function () {
    user.init();
    app.openCurtain();
};

app.init = function () {
    curtain.init();
    store.setup(VERSION);
    runner.init();
    editor.init();
    fixCSSCalc();
    return route({
        "\\?code=([a-z0-9]*)" : app.onActionOAuthRedirect,
        "\/#\/(runner)\\\/(\\w+)\\\/(\\w+)" : app.onActionRunner,
        "" : app.onActionDefault
    });
};

qstart.then(app.init);
